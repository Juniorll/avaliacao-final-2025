<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avaliação Interativa - Filosofia Lean</title>
    
    <!-- Carrega o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configuração do Tailwind (para usar a fonte Inter) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            }
        }
    </script>
    
    <!-- Estilos CSS personalizados -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none; /* Padrão */
        }
        
        /* Estilo para a alternativa selecionada */
        .alternativa-selecionada {
            background-color: #D1E5F1; /* Azul claro */
            border-color: #007BFF; /* Azul mais escuro */
            font-weight: 600;
        }

        /* Oculta os spinners de input[type=number] */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
          -moz-appearance: textfield; /* Firefox */
        }

        /* Animação de fade-in */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <!-- Container Principal -->
    <div class="bg-white w-full max-w-3xl rounded-lg shadow-2xl overflow-hidden">

        <!-- ===== 1. TELA DE INÍCIO ===== -->
        <div id="inicio-container" class="p-8 md:p-12 fade-in">
            <h1 class="text-3xl font-bold text-blue-800 mb-4">Avaliação sobre Filosofia Lean</h1>
            <p class="text-gray-600 mb-8">Por favor, preencha seus dados para iniciar a avaliação. A prova é composta por 20 questões de múltipla escolha.</p>
            
            <form id="form-inicio" class="space-y-6">
                <div>
                    <label for="nome" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                    <input type="text" id="nome" name="nome" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                
                <div>
                    <label for="colegio" class="block text-sm font-medium text-gray-700">Colégio / Instituição</label>
                    <input type="text" id="colegio" name="colegio" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                
                <div>
                    <!-- Campo de data preenchido automaticamente, mas editável se necessário -->
                    <label for="data" class="block text-sm font-medium text-gray-700">Data</label>
                    <input type="date" id="data" name="data" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-blue-700 transition-all duration-300 text-lg">
                    Iniciar Prova
                </button>
            </form>

            <!-- Botão de Login do Professor -->
            <div class="text-center mt-6">
                <button id="login-professor-btn" class="text-sm text-gray-500 hover:text-blue-600 hover:underline">
                    Login do Professor
                </button>
            </div>
        </div>

        <!-- ===== 2. TELA DE AVISO DE SEGURANÇA ===== -->
        <div id="aviso-container" class="p-8 md:p-12 fade-in hidden">
            <h1 class="text-3xl font-bold text-red-700 mb-6">Atenção: Sistema de Segurança</h1>
            <div class="space-y-4 text-gray-700 text-lg">
                <p>Esta é uma avaliação monitorada. As seguintes ações <strong class="text-red-600">NÃO</strong> são permitidas:</p>
                <ul class="list-disc list-inside space-y-2 pl-4">
                    <li>Minimizar a janela do navegador.</li>
                    <li>Alternar para outras abas ou aplicativos.</li>
                    <li>Sair da tela cheia.</li>
                    <li>Copiar qualquer conteúdo da prova.</li>
                </ul>
                <p class="font-semibold mt-6">Para uma melhor experiência e para evitar problemas, recomendamos fortemente que você ative o <strong class="text-blue-600">Modo de Tela Cheia (pressione F11)</strong> agora.</p>
                
                <p class="font-bold text-red-600 mt-4">Na <strong class="underline">primeira detecção</strong> de uma ação anormal, você receberá um aviso. Na <strong class="underline">segunda detecção</strong>, sua prova será encerrada automaticamente e você terá que reiniciar.</p>
            </div>
            
            <button id="comecar-quiz-btn" class="mt-10 w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-green-700 transition-all duration-300 text-lg">
                Entendido, começar a avaliação
            </button>
        </div>

        <!-- ===== 3. TELA DO QUIZ ===== -->
        <div id="quiz-container" class="p-8 md:p-12 hidden">
            <!-- Cabeçalho do Quiz -->
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 id="nome-aluno-quiz" class="text-xl font-semibold text-blue-800"></h2>
                    <p id="colegio-aluno-quiz" class="text-sm text-gray-500"></p>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-bold text-gray-700">
                        Questão <span id="questao-atual-num"></span> de <span id="questao-total-num">20</span>
                    </div>
                    <div id="pontos-questao" class="text-sm font-medium text-blue-600 bg-blue-100 px-2 py-1 rounded"></div>
                </div>
            </div>

            <!-- Botão de Consulta de Material -->
            <div class="mb-4 text-center">
                <button id="consultar-btn" class="w-full sm:w-auto px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-all duration-300">
                    Consultar Material de Apoio
                </button>
            </div>

            <!-- Card da Questão -->
            <div id="questao-card" class_="bg-gray-50 p-6 rounded-lg shadow-inner border border-gray-200 fade-in">
                <p id="texto-questao" class="text-lg font-medium text-gray-900 mb-6"></p>
                
                <!-- Alternativas -->
                <div id="alternativas-container" class="space-y-4">
                    <!-- Alternativas serão injetadas aqui pelo JS -->
                </div>
            </div>

            <!-- Botão de Próxima -->
            <button id="proxima-btn" class="mt-8 w-full bg-gray-400 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all duration-300 text-lg" disabled>
                Próxima Questão
            </button>
        </div>

        <!-- ===== 4. TELA DE RESULTADO ===== -->
        <div id="resultado-container" class="p-8 md:p-12 text-center fade-in hidden">
            <h1 class="text-3xl font-bold text-blue-800 mb-4">Avaliação Concluída!</h1>
            <p id="nome-aluno-resultado" class="text-xl text-gray-700 mb-8"></p>
            
            <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-8 w-fit mx-auto mb-8">
                <p class="text-lg text-gray-600">Sua pontuação final foi:</p>
                <div class="text-7xl font-extrabold text-blue-700 my-4">
                    <span id="pontuacao-final">0</span>
                </div>
                <p class="text-lg text-gray-600">de <span id="pontuacao-maxima"></span> pontos possíveis.</p>
            </div>
            
            <p id="feedback-firebase" class="text-gray-500 mb-8"></p>

            <button onclick="reiniciarProva()" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-blue-700 transition-all duration-300 text-lg">
                Voltar ao Início
            </button>
        </div>

        <!-- ===== 5. TELA DE ELIMINADO ===== -->
        <div id="eliminado-container" class="p-8 md:p-12 text-center fade-in hidden">
            <h1 class="text-3xl font-bold text-red-700 mb-4">Prova Encerrada</h1>
            <p class="text-xl text-gray-700 mb-8">Uma ação não permitida foi detectada pela segunda vez e sua avaliação foi encerrada automaticamente.</p>
            
            <div class="bg-red-50 border-2 border-red-200 rounded-lg p-8 mb-8">
                <p class="text-lg text-red-800">Seu progresso não foi salvo. Você será redirecionado para a tela inicial e deverá reiniciar a avaliação. Um novo conjunto de questões será sorteado.</p>
            </div>

            <button onclick="reiniciarProva()" class="w-full bg-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-red-700 transition-all duration-300 text-lg">
                Reiniciar Avaliação
            </button>
        </div>

        <!-- ===== 6. TELA DE ADMIN (PROFESSOR) ===== -->
        <div id="admin-container" class="p-8 md:p-12 fade-in hidden">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-indigo-800">Painel do Professor</h1>
                <button id="admin-voltar-btn" class="text-sm text-gray-600 hover:text-blue-600 hover:underline">
                    Sair e Voltar ao Início
                </button>
            </div>
            
            <p class="text-gray-600 mb-6">Aqui você pode consultar os resultados de todos os alunos que finalizaram a avaliação.</p>
            
            <div class="space-y-4 sm:space-y-0 sm:flex sm:space-x-4 mb-6">
                <button id="buscar-notas-btn" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-blue-700 transition-all duration-300 text-lg">
                    Buscar Notas
                </button>
                <button id="exportar-csv-btn" class="w-full sm:w-auto bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-green-700 transition-all duration-300 text-lg hidden">
                    Exportar para CSV (Excel)
                </button>
            </div>

            <!-- Tabela de Resultados -->
            <div id="tabela-container" class="w-full overflow-x-auto">
                <p id="admin-feedback" class="text-gray-500"></p>
                <table id="tabela-resultados" class="min-w-full bg-white border border-gray-300 hidden">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Aluno</th>
                            <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Colégio</th>
                            <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Data</th>
                            <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Pontuação</th>
                            <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Max</th>
                            <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">ID da Prova</th>
                        </tr>
                    </thead>
                    <tbody id="tabela-resultados-body">
                        <!-- Linhas serão injetadas aqui -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- ===== MODAL DE ALERTA (PRIMEIRA DETECÇÃO) ===== -->
    <div id="modal-alerta" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[70] hidden fade-in">
        <div class="bg-white w-full max-w-lg rounded-lg shadow-2xl p-8 text-center">
            <h2 class="text-3xl font-bold text-yellow-600 mb-6">Atenção!</h2>
            <p class="text-lg text-gray-700 mb-4">Detectamos uma ação anormal (como trocar de aba, minimizar ou tentar copiar). Esta é a sua <strong class="font-bold">primeira advertência</strong>.</p>
            <p class="text-lg text-gray-700 font-semibold">Se ocorrer novamente, a prova será <strong class="text-red-600">automaticamente encerrada</strong>.</p>
            <button id="fechar-modal-btn" class="mt-8 w-full bg-yellow-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-yellow-600 transition-all duration-300 text-lg">
                Entendido, voltar à prova
            </button>
        </div>
    </div>

    <!-- ===== MODAL DE LOGIN PROFESSOR ===== -->
    <div id="modal-login-professor" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[70] hidden fade-in">
        <div class="bg-white w-full max-w-sm rounded-lg shadow-2xl p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Login do Professor</h2>
            <form id="form-login-professor">
                <div class="space-y-4">
                    <div>
                        <label for="senha-professor" class="block text-sm font-medium text-gray-700">Senha</label>
                        <input type="password" id="senha-professor" name="senha-professor" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <p id="erro-login-professor" class="text-sm text-red-600 hidden">Senha incorreta. Tente novamente.</p>
                    <div class="flex space-x-4">
                        <button type="button" id="cancelar-login-btn" class="w-1/2 bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-lg hover:bg-gray-300 transition-all duration-300">
                            Cancelar
                        </button>
                        <button type="submit" class="w-1/2 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-blue-700 transition-all duration-300">
                            Entrar
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- ===== MODAL DE CONSULTA PDF ===== -->
    <div id="modal-pdf" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[60] hidden fade-in">
        <div class="bg-white w-full max-w-4xl h-[90vh] rounded-lg shadow-2xl p-6 flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-indigo-700">Material de Consulta</h2>
                <button id="fechar-pdf-btn" class="text-gray-600 hover:text-red-600 font-bold text-3xl">&times;</button>
            </div>
            <p class="text-sm text-gray-600 mb-4">Você pode navegar pelo material abaixo. Feche esta janela para retornar à questão.</p>
            <div class="flex-1 border border-gray-300 rounded-lg overflow-hidden">
                <!-- 
                    NOTA PARA O PROFESSOR: 
                    O arquivo "Referencial Completo de Estudo LEAN.pdf" deve estar na MESMA PASTA 
                    que este arquivo index.html no seu servidor (ex: GitHub Pages) para funcionar.
                -->
                <iframe id="pdf-iframe" src="Referencial Completo de Estudo LEAN.pdf" width="100%" height="100%" title="Material de Consulta PDF"></iframe>
            </div>
        </div>
    </div>


    <!-- ===== SCRIPTS ===== -->
    
    <!-- Scripts do Firebase (MANDATÓRIO) -->
    <script type="module">
        // Importar funções necessárias dos SDKs do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, addDoc, setLogLevel, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variáveis Globais de Configuração (Fornecidas pelo Ambiente) ---
        
        // Configuração do Firebase
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : { apiKey: "AIzaSyARprg9q4VHYsFxOPSonpjjBnGuaTPKItM", authDomain: "avaliacao-f1dab.firebaseapp.com", projectId: "avaliacao-f1dab" };
        
        // ID da Aplicação
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // Token de Autenticação Inicial
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Variáveis Globais da Aplicação ---
        let db, auth, userId;
        let infoAluno = {};
        let questoesSorteadas = [];
        let questaoAtualIndex = 0;
        let pontuacaoTotal = 0;
        let pontuacaoMaximaPossivel = 0;
        let respostasAluno = [];
        let alternativaSelecionada = null; // { texto: string, correta: boolean }
        let tentativasSaida = 0;
        let provaIniciada = false;
        let isModalPdfOpen = false; // Flag para controlar o modal do PDF
        let dadosAlunosExport = []; // Array para guardar dados para CSV

        // --- Banco de Questões (Baseado no PDF) ---
        // ATUALIZAÇÃO: Estudos de caso mais detalhados e conceitos contextualizados.
        // Pelo menos 40 questões (20 grupos de 2 variações)
        // 60%+ são estudos de caso e alternativas com tamanho balanceado.
        const questionBank = [
            // Grupo 1: Definição de Lean (Fácil - Conhecimento)
            { id: 1.1, grupo: 1, texto: "O 'Lean' é uma filosofia de gestão inspirada no Sistema Toyota de Produção (TPS), desenvolvido em um Japão pós-guerra com escassez de recursos. Qual era o foco principal e radicalmente diferente do TPS em comparação com a produção em massa ocidental?", 
              alternativas: [
                { texto: "Focar na 'economia de escala', ou seja, produzir o máximo de peças possível para reduzir o custo unitário de cada peça.", correta: false },
                { texto: "Focar na 'economia de fluxo' e na eliminação sistemática de qualquer atividade que não agregasse valor ao cliente (desperdício).", correta: true },
                { texto: "Focar na automação total e robótica, substituindo operadores humanos para garantir a máxima velocidade de produção.", correta: false },
                { texto: "Focar na compra de vastos estoques de matéria-prima para garantir proteção contra a escassez de recursos no Japão.", correta: false },
                { texto: "Focar no controle estatístico da qualidade (Six Sigma) para reduzir a variabilidade do processo, sendo este o pilar central.", correta: false }
              ], nivel: 'facil', pontos: 3, bloom: 'Conhecimento' },
            { id: 1.2, grupo: 1, texto: "A filosofia Lean, derivada do Sistema Toyota de Produção (TPS), foi uma resposta à escassez de recursos e capital. A filosofia central de Taiichi Ohno era eliminar desperdícios. Qual é a definição fundamental de 'desperdício' sob esta ótica?",
              alternativas: [
                { texto: "Qualquer atividade que custe mais de um certo valor pré-definido pelo departamento financeiro da empresa.", correta: false },
                { texto: "Qualquer processo manual que poderia ser automatizado, mesmo que o custo da automação seja extremamente alto.", correta: false },
                { texto: "Qualquer atividade que consome recursos (tempo, material, espaço) mas que não agrega valor sob a perspectiva do cliente.", correta: true },
                { texto: "Apenas o material de sucata ou peças defeituosas que são identificados no final da linha de produção pela inspeção.", correta: false },
                { texto: "A falta de 'economia de escala', ou seja, não produzir em lotes grandes o suficiente para atingir o custo unitário mínimo.", correta: false }
              ], nivel: 'facil', pontos: 3, bloom: 'Conhecimento' },
            
            // Grupo 2: Arquitetos do TPS (Fácil - Conhecimento)
            { id: 2.1, grupo: 2, texto: "O TPS é creditado a dois arquitetos principais. Um foi Taiichi Ohno, o 'pai' da filosofia de eliminação de desperdícios. O outro foi um engenheiro consultor que desenvolveu mecanismos práticos como o Poka-Yoke (à prova de erros) e o SMED (Troca Rápida de Ferramentas). Quem foi esse engenheiro?", 
              alternativas: [
                { texto: "W. Edwards Deming, o estatístico americano que ensinou controle de qualidade e o ciclo PDCA no Japão.", correta: false },
                { texto: "James P. Womack, o pesquisador do MIT que mais tarde cunhou o termo 'Lean' no Ocidente.", correta: false },
                { texto: "Eiji Toyoda, o líder executivo da Toyota que deu a visão e o suporte para a criação do sistema.", correta: false },
                { texto: "Henry Ford, que, embora rival, inspirou Ohno com seu foco original no fluxo de linha contínuo.", correta: false },
                { texto: "Shigeo Shingo, o engenheiro industrial que tornou a 'produção sem estoque' (JIT) tecnicamente viável.", correta: true }
              ], nivel: 'facil', pontos: 3, bloom: 'Conhecimento' },
            { id: 2.2, grupo: 2, texto: "Dois indivíduos são reconhecidos como os principais arquitetos do TPS. Taiichi Ohno é considerado o 'pai' do TPS e o arquiteto dos pilares JIT e Jidoka. Quem foi seu colaborador principal, um consultor famoso por criar ferramentas de engenharia como o Poka-Yoke e o SMED?",
              alternativas: [
                { texto: "Shigeo Shingo, que ajudou a traduzir a filosofia de Ohno em mecanismos práticos de engenharia.", correta: true },
                { texto: "Daniel T. Jones, que, junto com Womack, escreveu 'A Máquina que Mudou o Mundo' e popularizou o Lean.", correta: false },
                { texto: "Eric Ries, que muito mais tarde adaptou os conceitos do Lean para o mundo das startups de tecnologia.", correta: false },
                { texto: "W. Edwards Deming, que focou primariamente no controle estatístico da qualidade (PDCA).", correta: false },
                { texto: "Eiji Toyoda, que foi o gestor e líder da Toyota, mas não o arquiteto de engenharia das ferramentas.", correta: false }
              ], nivel: 'facil', pontos: 3, bloom: 'Conhecimento' },

            // Grupo 3: Diferença Lean vs TPS (Médio - Estudo de Caso)
            { id: 3.1, grupo: 3, texto: "Estudo de Caso: Uma empresa de software europeia decide adotar o 'Lean'. Eles implementam 'Eventos Kaizen' de 3 dias para redesenhar fluxos de trabalho (VSM) e adotam o JIT (Just-in-Time) para gerenciar tarefas. No entanto, a qualidade do código despenca, pois defeitos (bugs) passam rapidamente para o cliente. Qual pilar fundamental do TPS original foi 'amplamente ignorado ou mal compreendido' nesta implementação 'Lean'?",
              alternativas: [
                { texto: "O pilar Jidoka (autonomação ou qualidade na fonte), que exige parar o processo imediatamente ao detectar um defeito para impedir sua propagação.", correta: true },
                { texto: "O Mapeamento do Fluxo de Valor (VSM), pois a ferramenta claramente não foi capaz de identificar os gargalos no fluxo de código.", correta: false },
                { texto: "O conceito de 5S (Organização), pois os programadores provavelmente estavam com suas áreas de trabalho digitais desorganizadas.", correta: false },
                { texto: "O pilar JIT (Just-in-Time), pois a empresa o adotou, mas deveria ter focado em um sistema 'Push' (empurrado) para software.", correta: false },
                { texto: "A filosofia de 'Respeito pelas Pessoas', pois os gerentes provavelmente não respeitaram os programadores durante os eventos.", correta: false }
              ], nivel: 'medio', pontos: 5, bloom: 'Aplicação' },
            { id: 3.2, grupo: 3, texto: "Estudo de Caso: O livro 'A Máquina que Mudou o Mundo' (1990) introduziu o termo 'Lean' para descrever o Sistema Toyota de Produção (TPS). Por que foi necessário criar um termo genérico ('Lean') em vez de simplesmente chamar o sistema de 'TPS' no Ocidente?",
              alternativas: [
                { texto: "Porque o termo 'Lean' era uma tradução literal e exata da palavra japonesa 'Kaizen', facilitando a compreensão.", correta: false },
                { texto: "Porque o TPS era focado exclusivamente em fabricação de carros, e o 'Lean' foi criado para ser aplicado apenas em hospitais e bancos.", correta: false },
                { texto: "Porque a Toyota proibiu o uso do termo 'TPS' por qualquer outra empresa, forçando o MIT a inventar um novo nome.", correta: false },
                { texto: "Foi uma 'necessidade de tradução cultural' para desvincular a filosofia da Toyota, permitindo que concorrentes (como a GM) a adotassem sem parecer que estavam copiando um rival.", correta: true },
                { texto: "Porque o 'Lean' é fundamentalmente diferente, pois foca no Six Sigma e estatística, enquanto o TPS foca apenas em ferramentas visuais.", correta: false }
              ], nivel: 'medio', pontos: 5, bloom: 'Compreensão' },

            // Grupo 4: 3M (Muda, Mura, Muri) (Difícil - Estudo de Caso)
            { id: 4.1, grupo: 4, texto: "Estudo de Caso: Uma transportadora opera com alta 'Mura' (irregularidade), recebendo 5.000 pacotes às segundas e apenas 1.000 às sextas. Para 'dar conta do recado' nas segundas, a gestão força os operadores a trabalhar em ritmo frenético, sem pausas ('Muri', sobrecarga). Isso resulta em pacotes danificados e erros de envio ('Muda', desperdício). Qual é a interconexão causal que o Lean buscaria resolver na raiz?",
              alternativas: [
                { texto: "Atacar o 'Muda' (erros) primeiro, implementando uma estação de inspeção tripla no final do processo para corrigir os envios.", correta: false },
                { texto: "Atacar o 'Muri' (sobrecarga) primeiro, contratando o triplo de funcionários apenas para as segundas-feiras, mesmo que fiquem ociosos.", correta: false },
                { texto: "Atacar a 'Mura' (irregularidade) primeiro, tentando nivelar o fluxo de pacotes (Heijunka) ao longo da semana para estabilizar o processo.", correta: true },
                { texto: "Atacar o 'Muda' (danos) primeiro, investindo em embalagens mais caras e robustas para que resistam ao ritmo frenético.", correta: false },
                { texto: "Atacar o 'Muri' (sobrecarga) primeiro, aplicando o 5S para organizar a área, o que fará os operadores trabalharem mais rápido.", correta: false }
              ], nivel: 'dificil', pontos: 8, bloom: 'Análise' },
            { id: 4.2, grupo: 4, texto: "Estudo de Caso: Um hospital sofre com 'Mura' (irregularidade) na triagem, com picos de pacientes às 10h e vales às 15h. Durante os picos, enfermeiros correm freneticamente ('Muri', sobrecarga), levando a erros de registro ('Muda', defeitos) e longas filas ('Muda', espera). A maioria das iniciativas foca em 'caçar o desperdício' (Muda). Por que essa abordagem falha em resolver o problema sistêmico?",
              alternativas: [
                { texto: "Porque o 'Muda' (erros) é o sintoma visível, mas a causa raiz é a 'Mura' (irregularidade) que força o 'Muri' (sobrecarga).", correta: true },
                { texto: "Porque o 'Muda' (erros) só pode ser resolvido com mais treinamento, independentemente da irregularidade (Mura) ou sobrecarga (Muri).", correta: false },
                { texto: "Porque o 'Muri' (sobrecarga) é a verdadeira causa raiz, e o hospital deveria proibir os picos de pacientes às 10h.", correta: false },
                { texto: "Porque os 3M (Muda, Mura, Muri) são conceitos totalmente independentes e não possuem uma relação causal entre si.", correta: false },
                { texto: "Porque o 'Muda' (espera) é a causa raiz de todos os outros problemas, e o hospital deveria focar apenas em reduzir as filas.", correta: false }
              ], nivel: 'dificil', pontos: 8, bloom: 'Análise' },

            // Grupo 5: Muri (Fácil - Conhecimento)
            { id: 5.1, grupo: 5, texto: "A filosofia Lean busca eliminar os '3M'. O 'Muda' é o desperdício e o 'Mura' é a irregularidade. O que significa 'Muri' e qual é um exemplo clássico disso em um processo?",
              alternativas: [
                { texto: "Significa 'melhoria' e é exemplificado por um 'Evento Kaizen' que melhora um processo.", correta: false },
                { texto: "Significa 'qualidade' e é exemplificado por um sistema 'Jidoka' que para a linha.", correta: false },
                { texto: "Significa 'sobrecarga' e é exemplificado por exigir que máquinas operem 100% do tempo sem manutenção.", correta: true },
                { texto: "Significa 'fluxo' e é exemplificado por um 'sistema puxado' (Pull) que usa Kanban.", correta: false },
                { texto: "Significa 'variabilidade' e é exemplificado por picos e vales inesperados na demanda do cliente.", correta: false }
              ], nivel: 'facil', pontos: 3, bloom: 'Conhecimento' },
            { id: 5.2, grupo: 5, texto: "Os '3M' são os inimigos do Lean. Se 'Muda' é desperdício (ex: espera) e 'Mura' é irregularidade (ex: volumes de produção inconsistentes), o que é 'Muri'?",
              alternativas: [
                { texto: "A sobrecarga de pessoas ou equipamentos, exigindo que operem além de sua capacidade sustentável.", correta: true },
                { texto: "O ato de inspecionar a qualidade no final do processo, em vez de na fonte (Jidoka).", correta: false },
                { texto: "O cartão visual (Kanban) que é usado para sinalizar a produção em um sistema puxado.", correta: false },
                { texto: "O desperdício de talento, que é o oitavo desperdício do 'Muda' (Habilidades Não Utilizadas).", correta: false },
                { texto: "O método científico (PDCA) usado para implementar o Kaizen (melhoria contínua).", correta: false }
              ], nivel: 'facil', pontos: 3, bloom: 'Conhecimento' },
            
            // Grupo 6: Pior Desperdício (Superprodução) (Médio - Estudo de Caso)
            { id: 6.1, grupo: 6, texto: "Estudo de Caso: Uma fábrica de calçados, operando em um sistema 'Empurrado' (Push), decide produzir 50.000 pares de botas de inverno em pleno verão, baseando-se em uma previsão de vendas. Por que a 'Superprodução' (produzir mais, mais cedo ou mais rápido do que o necessário) é considerada o 'pior dos desperdícios'?",
              alternativas: [
                { texto: "Porque ela é a causa direta de muitos outros desperdícios: gera 'Estoque' (Muda), que exige 'Transporte' (Muda) e esconde 'Defeitos' (Muda).", correta: true },
                { texto: "Porque o custo do 'Movimento' (Muda) dos operadores para fabricar tantas botas é o maior custo isolado da fábrica.", correta: false },
                { texto: "Porque o 'Processamento Excessivo' (Muda), como polir as botas mais do que o cliente valoriza, é o verdadeiro problema.", correta: false },
                { texto: "Porque a 'Espera' (Muda) das máquinas entre os lotes de produção é o maior gargalo, e a superprodução ajuda a reduzir isso.", correta: false },
                { texto: "Porque o 'Talento Não Utilizado' (Muda) é o pior desperdício, pois os operadores poderiam estar pensando em novos designs.", correta: false }
              ], nivel: 'medio', pontos: 5, bloom: 'Aplicação' },
            { id: 6.2, grupo: 6, texto: "Estudo de Caso: Uma padaria decide assar 200 pães às 5h da manhã, baseando-se em uma previsão (Push), antes que qualquer cliente chegue. No final do dia, 80 pães não vendidos são descartados. Este é um exemplo clássico de 'Superprodução'. Por que este desperdício é considerado o mais grave pelo TPS?",
              alternativas: [
                { texto: "Porque ele mascara problemas. Se a padaria fizesse 200 pães e a máquina quebrasse, ninguém notaria por causa do estoque.", correta: false },
                { texto: "Porque ele causa outros desperdícios. Os 200 pães geram 'Estoque', ocupam espaço e, se estragam, viram 'Defeitos'.", correta: true },
                { texto: "Porque o 'Movimento' do padeiro para mover 200 pães é o maior desperdício de tempo no processo.", correta: false },
                { texto: "Porque o 'Processamento Excessivo' (deixar o pão muito bonito) é mais caro do que o custo do pão em si.", correta: false },
                { texto: "Porque a 'Espera' do cliente pelo pão é o pior desperdício, e a superprodução garante que o cliente nunca espere.", correta: false }
              ], nivel: 'medio', pontos: 5, bloom: 'Aplicação' },

            // Grupo 7: 8º Desperdício (Talento) (Médio - Estudo de Caso)
            { id: 7.1, grupo: 7, texto: "Estudo de Caso: Em um 'Evento Kaizen', a gestão de um hospital redesenha o layout da farmácia sem consultar os técnicos que trabalham lá há anos. O novo layout, embora bonito, é impraticável. A gestão cometeu qual dos 8 desperdícios (Muda)?",
              alternativas: [
                { texto: "O desperdício de 'Transporte', pois os medicamentos agora precisam ser transportados por um caminho mais longo.", correta: false },
                { texto: "O desperdício de 'Habilidades Não Utilizadas' (Talento), pois subaproveitou o conhecimento e a criatividade da equipe da linha de frente.", correta: true },
                { texto: "O desperdício de 'Movimento', pois os técnicos agora precisam caminhar mais para pegar os medicamentos.", correta: false },
                { texto: "O desperdício de 'Processamento Excessivo', pois o novo layout provavelmente custou muito caro para ser implementado.", correta: false },
                { texto: "O desperdício de 'Defeitos', pois o novo layout é um erro de design que precisará de retrabalho.", correta: false }
              ], nivel: 'medio', pontos: 5, bloom: 'Aplicação' },
            { id: 7.2, grupo: 7, texto: "Estudo de Caso: Uma empresa de engenharia contrata um engenheiro sênior com PhD, mas o aloca para preencher planilhas e agendar reuniões, tarefas que poderiam ser automatizadas ou delegadas. Qual dos 8 desperdícios (Muda) está sendo cometido?",
              alternativas: [
                { texto: "O desperdício de 'Processamento Excessivo', pois pagar um PhD para agendar reuniões é mais caro do que o necessário.", correta: false },
                { texto: "O desperdício de 'Espera', pois o engenheiro provavelmente está esperando por tarefas mais desafiadoras.", correta: false },
                { texto: "O desperdício de 'Habilidades Não Utilizadas' (Talento), pois o potencial intelectual e criativo do colaborador está sendo subaproveitado.", correta: true },
                { texto: "O desperdício de 'Defeitos', pois o engenheiro sênior provavelmente cometerá erros ao agendar as reuniões.", correta: false },
                { texto: "O desperdício de 'Superprodução', pois o engenheiro está produzindo mais agendamentos de reunião do que o necessário.", correta: false }
              ], nivel: 'medio', pontos: 5, bloom: 'Aplicação' },

            // Grupo 8: 5 Princípios (Fácil - Conhecimento)
            { id: 8.1, grupo: 8, texto: "Womack & Jones definiram uma 'receita' de 5 princípios sequenciais para a transformação Lean. O primeiro é 'Valor'. Qual é a sequência correta dos quatro princípios restantes?",
              alternativas: [
                { texto: "2. Fluxo, 3. Puxar, 4. Mapeamento do Fluxo de Valor, 5. Perfeição.", correta: false },
                { texto: "2. Mapeamento do Fluxo de Valor, 3. Fluxo, 4. Puxar, 5. Perfeição.", correta: true },
                { texto: "2. Mapeamento do Fluxo de Valor, 3. Puxar, 4. Fluxo, 5. Perfeição.", correta: false },
                { texto: "2. Puxar, 3. Fluxo, 4. Perfeição, 5. Mapeamento do Fluxo de Valor.", correta: false },
                { texto: "2. Perfeição, 3. Fluxo, 4. Puxar, 5. Mapeamento do Fluxo de Valor.", correta: false }
              ], nivel: 'facil', pontos: 3, bloom: 'Conhecimento' },
            { id: 8.2, grupo: 8, texto: "Os 5 Princípios do Lean Thinking (Womack & Jones) são o framework prescritivo para a transformação. O primeiro passo é 'Especificar o Valor'. O segundo é 'Mapear o Fluxo de Valor'. Qual é o terceiro princípio, que é o oposto da produção em lotes?",
              alternativas: [
                { texto: "Puxar (Produção Puxada)", correta: false },
                { texto: "Perfeição (Kaizen)", correta: false },
                { texto: "Fluxo (Fluxo Contínuo)", correta: true },
                { texto: "Jidoka (Autonomação)", correta: false },
                { texto: "Muda (Eliminar Desperdício)", correta: false }
              ], nivel: 'facil', pontos: 3, bloom: 'Conhecimento' },

            // Grupo 9: VSM (Médio - Estudo de Caso)
            { id: 9.1, grupo: 9, texto: "Estudo de Caso: Uma equipe de Lean Office usa o Mapeamento do Fluxo de Valor (VSM), uma ferramenta de diagnóstico, para analisar o processo de integração de novos funcionários. Eles descobrem que o processo leva 20 dias (Lead Time), mas o tempo real de trabalho (Tempo de Agregação de Valor, ou VA) é de apenas 3 horas. O que o VSM torna visível que um fluxograma comum não mostraria?",
              alternativas: [
                { texto: "O VSM mostra apenas a sequência de tarefas (ex: 'Preencher Formulário', 'Treinamento'), sem dados de tempo.", correta: false },
                { texto: "O VSM foca apenas no fluxo de informação (e-mails) e ignora completamente o fluxo de material (crachás).", correta: false },
                { texto: "O VSM quantifica o tempo de VA (3h) vs. NVA (Não Agrega Valor), revelando que 99% do tempo é desperdício (Espera, Estoque).", correta: true },
                { texto: "O VSM é usado apenas para projetar o 'Estado Futuro' ideal, e não serve para analisar o 'Estado Atual'.", correta: false },
                { texto: "O VSM é uma ferramenta de 5S usada para organizar a mesa do novo funcionário, não para mapear o fluxo.", correta: false }
              ], nivel: 'medio', pontos: 5, bloom: 'Análise' },
            { id: 9.2, grupo: 9, texto: "Estudo de Caso: Ao usar o Mapeamento do Fluxo de Valor (VSM), uma ferramenta que mapeia tanto o fluxo de material quanto o de informação, uma fábrica descobre que seu 'Estado Atual' tem 10 dias de Lead Time. A equipe projeta um 'Estado Futuro' que elimina gargalos. Quais princípios Lean são tipicamente incorporados neste novo mapa?",
              alternativas: [
                { texto: "Aumento da produção em lotes e um sistema 'Empurrado' (Push) baseado em previsões mais precisas.", correta: false },
                { texto: "Implementação de fluxo contínuo (ou 'one-piece flow') e um sistema de produção 'Puxada' (Pull), como o Kanban.", correta: true },
                { texto: "Aumento dos estoques de segurança (WIP) entre cada etapa para garantir que as máquinas nunca parem.", correta: false },
                { texto: "Adição de mais estações de inspeção de qualidade no final do processo para capturar todos os defeitos.", correta: false },
                { texto: "Foco exclusivo no 5S (Organização), assumindo que um local de trabalho limpo automaticamente cria fluxo.", correta: false }
              ], nivel: 'medio', pontos: 5, bloom: 'Análise' },

            // Grupo 10: Fluxo Contínuo vs. Lotes (Difícil - Estudo de Caso)
            { id: 10.1, grupo: 10, texto: "Estudo de Caso: Uma lavanderia industrial opera em 'lotes'. A Etapa 1 (Lavar) processa 100kg de roupa. A Etapa 2 (Secar) tem capacidade para 50kg. A Etapa 3 (Dobrar) é manual. Isso cria 'Espera' (roupas lavadas esperando a secadora) e 'Estoque' (roupas secas esperando para dobrar). Como o Princípio do 'Fluxo Contínuo' (one-piece flow) abordaria isso?",
              alternativas: [
                { texto: "O Fluxo Contínuo aumentaria o tamanho dos lotes, comprando uma lavadora de 200kg para maximizar a eficiência da Etapa 1.", correta: false },
                { texto: "O Fluxo Contínuo buscaria quebrar os lotes, idealmente movendo pequenos volumes (ou 'uma peça por vez') suavemente entre as etapas, balanceando o fluxo.", correta: true },
                { texto: "O Fluxo Contínuo focaria apenas em acelerar a Etapa 1 (Lavar), pois ela é o início do processo e define o ritmo.", correta: false },
                { texto: "O Fluxo Contínuo é o mesmo que 'Sistema Empurrado' (Push), então ele criaria uma previsão de demanda de roupas para a semana.", correta: false },
                { texto: "O Fluxo Contínuo adicionaria mais máquinas de secar (Etapa 2) para que elas fiquem ociosas, prontas para o lote de 100kg.", correta: false }
              ], nivel: 'dificil', pontos: 8, bloom: 'Aplicação' },
            { id: 10.2, grupo: 10, texto: "Estudo de Caso: Uma clínica de vacinação processa pacientes em grandes 'lotes'. 30 pacientes chegam às 9h, preenchem formulários (Lote 1), depois todos esperam pela triagem (Lote 2), e depois todos esperam pela aplicação (Lote 3), gerando longas 'Esperas'. O Princípio 3 do Lean é o 'Fluxo Contínuo'. Como ele mudaria essa clínica?",
              alternativas: [
                { texto: "Ele focaria em criar um 'fluxo de uma peça por vez' (one-patient flow), onde o Paciente 1 completaria todas as etapas (Formulário, Triagem, Aplicação) antes do Paciente 2 começar.", correta: false },
                { texto: "Ele agendaria todos os 30 pacientes para as 9h, mas contrataria 30 enfermeiras para que todos fossem atendidos em um único grande lote.", correta: false },
                { texto: "Ele buscaria um fluxo suave e contínuo, talvez agendando 2 pacientes a cada 5 minutos e fazendo-os passar pelas etapas sem paradas ou acúmulo de lotes.", correta: true },
                { texto: "Ele eliminaria a etapa de 'Triagem' (NVA), pois ela é um desperdício de Processamento Excessivo, e enviaria todos direto para a aplicação.", correta: false },
                { texto: "Ele manteria os lotes, mas aplicaria o 5S (Organização) na sala de espera para que os pacientes ficassem mais confortáveis.", correta: false }
              ], nivel: 'dificil', pontos: 8, bloom: 'Aplicação' },
            
            // Grupo 11: Sistema Puxado (Pull) (Médio - Estudo de Caso)
            { id: 11.1, grupo: 11, texto: "Estudo de Caso: Uma montadora opera em um 'Sistema Empurrado' (Push). Ela fabrica 1.000 motores com base em uma previsão e os 'empurra' para a linha de montagem, que só precisava de 200. O resultado é um enorme 'Estoque'. Qual é a lógica oposta, o 'Sistema Puxado' (Pull System), o Princípio 4 do Lean?",
              alternativas: [
                { texto: "No 'Sistema Puxado', a linha de montagem 'puxa' (demanda) um motor da fábrica de motores apenas quando precisa de um, e a fábrica produz apenas para repor o que foi consumido.", correta: true },
                { texto: "No 'Sistema Puxado', a gestão 'puxa' a alavanca de emergência (Andon) para parar a linha se a previsão de vendas estiver errada.", correta: false },
                { texto: "No 'Sistema Puxado', a fábrica de motores 'puxa' mais matéria-prima para produzir 1.500 motores, antecipando uma demanda maior.", correta: false },
                { texto: "Um 'Sistema Puxado' é o mesmo que 'Mura' (irregularidade), pois a demanda do cliente é irregular e puxa a produção de forma caótica.", correta: false },
                { texto: "No 'Sistema Puxado', os operadores 'puxam' as ideias de melhoria (Kaizen) da gestão, em vez de o contrário.", correta: false }
              ], nivel: 'medio', pontos: 5, bloom: 'Análise' },
            { id: 11.2, grupo: 11, texto: "Estudo de Caso: Em um restaurante, a cozinha opera em 'Sistema Puxado' (Pull). O chef não produz nada até que o garçom traga um pedido (a demanda real do cliente). Isso elimina a 'Superprodução' (Muda). Este sistema é a operacionalização de qual pilar ou conceito do TPS?",
              alternativas: [
                { texto: "O conceito de Jidoka (Autonomação), pois o chef para se a comida queimar.", correta: false },
                { texto: "O conceito de 5S (Organização), pois a cozinha precisa estar limpa para o sistema funcionar.", correta: false },
                { texto: "O conceito de Just-in-Time (JIT), pois o prato é feito 'apenas no momento necessário' e na 'quantidade necessária' (um), puxado pela demanda.", correta: true },
                { texto: "O conceito de TPM (Manutenção), pois os fogões precisam de manutenção para não quebrar.", correta: false },
                { texto: "O conceito de Muri (Sobrecarga), pois o chef fica sobrecarregado quando muitos pedidos chegam.", correta: false }
              ], nivel: 'medio', pontos: 5, bloom: 'Aplicação' },
            
            // Grupo 12: Perfeição (Kaizen/PDCA) (Difícil - Estudo de Caso)
            { id: 12.1, grupo: 12, texto: "Estudo de Caso: Uma equipe de logística usa o Ciclo PDCA (Plan-Do-Check-Act), o método científico para melhoria, para reduzir erros de envio. Eles identificam o problema e planejam uma mudança no leitor de código de barras (Plan). Eles implementam a mudança em um turno (Do). Eles medem e veem que os erros caíram 50% (Check). Qual é a etapa 'Act' (Agir) crucial que transforma isso em 'Kaizen' (melhoria contínua) em vez de apenas um experimento?",
              alternativas: [
                { texto: "A etapa 'Act' é celebrar o sucesso e dissolver a equipe, pois o problema foi resolvido e o experimento acabou.", correta: false },
                { texto: "A etapa 'Act' é padronizar a nova mudança (o novo leitor ou processo) como o 'novo normal' para todos os turnos e, em seguida, procurar o próximo problema (reiniciar o PDCA).", correta: true },
                { texto: "A etapa 'Act' é reverter a mudança, mesmo que tenha sido bem-sucedida, para provar que a melhoria não foi um acaso, e então refazer o 'Do'.", correta: false },
                { texto: "A etapa 'Act' é o mesmo que a etapa 'Do'; significa apenas 'agir' e implementar o plano original com mais intensidade.", correta: false },
                { texto: "A etapa 'Act' é documentar a falha (se houver) e punir a equipe para que não cometam o mesmo erro novamente.", correta: false }
              ], nivel: 'dificil', pontos: 8, bloom: 'Avaliação' },
            { id: 12.2, grupo: 12, texto: "O Princípio 5, 'Perfeição', é a busca incessante pela melhoria contínua (Kaizen). O motor que implementa o Kaizen é o Ciclo PDCA (Plan-Do-Check-Act). Se uma equipe implementa uma mudança (Do) e os resultados (Check) são negativos (o problema piorou), o que o ciclo PDCA determina que deve ser feito na etapa 'Act'?",
              alternativas: [
                { texto: "Na etapa 'Act', a equipe deve padronizar a mudança negativa, pois o método científico deve ser seguido à risca.", correta: false },
                { texto: "Na etapa 'Act', a equipe deve punir quem sugeriu a mudança (o 'Plan') e abandonar o ciclo PDCA.", correta: false },
                { texto: "Na etapa 'Act', a equipe deve aprender com o experimento que falhou, reverter a mudança e iniciar um novo ciclo PDCA com um novo 'Plan' (uma nova hipótese).", correta: true },
                { texto: "Na etapa 'Act', a equipe deve culpar os operadores por implementarem a mudança (o 'Do') incorretamente.", correta: false },
                { texto: "Na etapa 'Act', a equipe deve ignorar o 'Check' negativo e implementar a mudança em larga escala de qualquer maneira.", correta: false }
              ], nivel: 'dificil', pontos: 8, bloom: 'Avaliação' },

            // Grupo 13: JIT vs Kanban (Médio - Análise)
            { id: 13.1, grupo: 13, texto: "O Just-in-Time (JIT) é o pilar do TPS que dita 'produzir apenas o que é necessário, quando necessário'. O Kanban (cartão visual) é frequentemente confundido com ele. Qual é a relação precisa entre JIT e Kanban?",
              alternativas: [
                { texto: "JIT e Kanban são exatamente a mesma coisa; Kanban é apenas a palavra japonesa para JIT.", correta: false },
                { texto: "Kanban é a filosofia estratégica de 'estoque zero', enquanto o JIT é a ferramenta prática (o cartão) que a implementa.", correta: false },
                { texto: "JIT é a estratégia ou filosofia (produção puxada, fluxo contínuo), enquanto o Kanban é o mecanismo (o sinal visual ou o contêiner vazio) que permite ao JIT operar na prática.", correta: true },
                { texto: "JIT refere-se ao pilar da qualidade (Jidoka), enquanto o Kanban refere-se ao pilar do fluxo (produção puxada).", correta: false },
                { texto: "Kanban é usado para 'empurrar' (Push) a produção com base em previsões, enquanto o JIT é usado para 'puxar' (Pull) com base na demanda real.", correta: false }
              ], nivel: 'medio', pontos: 5, bloom: 'Análise' },
            { id: 13.2, grupo: 13, texto: "Estudo de Caso: Em uma fábrica, a Estação 2 (Montagem) precisa de caixas de parafusos da Estação 1 (Almoxarifado). Quando a Estação 2 esvazia uma caixa, ela a envia de volta para a Estação 1. A caixa vazia (o 'Kanban') é o sinal visual que autoriza a Estação 1 a repor *apenas* aquela caixa. Este sistema habilita qual pilar do TPS?",
              alternativas: [
                { texto: "O pilar Jidoka (Autonomação), pois a caixa vazia detecta um defeito na qualidade dos parafusos.", correta: false },
                { texto: "O pilar Just-in-Time (JIT), pois o Kanban (caixa vazia) garante que a produção seja 'puxada' (Pull) e que os parafusos cheguem 'exatamente quando necessários'.", correta: true },
                { texto: "O pilar TPM (Manutenção Produtiva Total), pois a caixa vazia indica que a Estação 2 precisa de manutenção.", correta: false },
                { texto: "O pilar 5S (Organização), pois a caixa vazia está sendo usada para manter a área limpa (Seiso).", correta: false },
                { texto: "O pilar Muri (Sobrecarga), pois a Estação 1 agora está sobrecarregada por ter que encher a caixa.", correta: false }
              ], nivel: 'medio', pontos: 5, bloom: 'Aplicação' },
            
            // Grupo 14: Jidoka (Difícil - Estudo de Caso)
            { id: 14.1, grupo: 14, texto: "Estudo de Caso: Em uma linha de engarrafamento, uma nova máquina (Automação Tradicional) enche 1.000 garrafas por minuto. No entanto, um bico entope e ela começa a encher garrafas com metade do volume. A máquina continua operando, produzindo milhares de garrafas defeituosas. Como o pilar 'Jidoka' (automação com toque humano) do TPS difere disso?",
              alternativas: [
                { texto: "O Jidoka focaria em quantidade, operando a 2.000 garrafas por minuto, independentemente dos defeitos.", correta: false },
                { texto: "O Jidoka é um processo puramente manual; ele proibiria a máquina de engarrafamento e usaria operadores.", correta: false },
                { texto: "O Jidoka é o mesmo que JIT; ele garantiria que as garrafas chegassem 'just-in-time', mas não lidaria com o defeito.", correta: false },
                { texto: "O Jidoka focaria em 'qualidade na fonte': a máquina seria dotada de inteligência (um sensor) para detectar a anormalidade (volume baixo) e parar imediatamente.", correta: true },
                { texto: "O Jidoka é o mesmo que Kanban; ele usaria um cartão visual para sinalizar que o bico estava entupido.", correta: false }
              ], nivel: 'dificil', pontos: 8, bloom: 'Análise' },
            { id: 14.2, grupo: 14, texto: "Estudo de Caso: Uma empresa implementa o JIT (Just-in-Time) e reduz seus estoques para quase zero, o que reduz custos. No entanto, eles ignoram o pilar 'gêmeo' do JIT, o Jidoka (qualidade na fonte). Por que o material afirma que um sistema JIT sem Jidoka é 'frágil'?",
              alternativas: [
                { texto: "Porque o Jidoka é o pilar que garante a manutenção (TPM) das máquinas, e sem ele o JIT não funciona.", correta: false },
                { texto: "Porque o JIT (com baixo estoque) faz com que um defeito produzido na Estação A chegue à Estação B em minutos. Sem o Jidoka (que para a linha na fonte), o sistema inteiro produzirá 100% de sucata rapidamente.", correta: true },
                { texto: "Porque o Jidoka é o pilar do 'Respeito pelas Pessoas', e sem ele os operadores não se sentem motivados a operar o JIT.", correta: false },
                { texto: "Porque o JIT é um sistema 'Push' (Empurrado) e o Jidoka é um sistema 'Pull' (Puxado), e eles entram em conflito direto.", correta: false },
                { texto: "Porque o Jidoka é a única forma de implementar o 5S (Organização), que é a fundação para o JIT.", correta: false }
              ], nivel: 'dificil', pontos: 8, bloom: 'Análise' },

            // Grupo 15: Poka-Yoke (Médio - Estudo de Caso)
            { id: 15.1, grupo: 15, texto: "Estudo de Caso: Em uma linha de montagem de motores, um operador frequentemente esquecia de instalar uma pequena vedação (um erro humano). A engenharia redesenhou a peça para que o motor não pudesse ser fechado se a vedação não estivesse no lugar (o pino-guia não encaixava). Este design, que torna o erro impossível, é um exemplo clássico de qual ferramenta Lean?",
              alternativas: [
                { texto: "Poka-Yoke (À prova de erros), pois o design do processo impede fisicamente a ocorrência do erro humano.", correta: true },
                { texto: "Jidoka (Autonomação), pois a linha para. (Nota: O Poka-Yoke habilita o Jidoka, mas a ferramenta em si é o Poka-Yoke).", correta: false },
                { texto: "Kanban (Sinal Visual), pois o pino-guia sinaliza visualmente que a vedação está faltando.", correta: false },
                { texto: "5S (Organização), pois a vedação agora tem um lugar certo (Seiton) e está mais organizada.", correta: false },
                { texto: "5 Porquês, pois a equipe usou esta técnica para descobrir por que o operador esquecia a vedação.", correta: false }
              ], nivel: 'medio', pontos: 5, bloom: 'Aplicação' },
            { id: 15.2, grupo: 15, texto: "O Poka-Yoke (à prova de erros) é um mecanismo de engenharia desenvolvido por Shigeo Shingo para atingir 'Zero Defeitos'. Qual dos exemplos abaixo NÃO é um Poka-Yoke?",
              alternativas: [
                { texto: "Um conector USB ou HDMI, que possui um formato específico que impede a inserção incorreta.", correta: false },
                { texto: "Um verificador ortográfico que *alerta* sobre um erro, mas permite que o usuário o ignore (Poka-Yoke de detecção/aviso).", correta: false },
                { texto: "Uma lista de verificação (checklist) que o operador deve assinar, confiando em sua memória e disciplina para evitar o erro.", correta: true },
                { texto: "Pinos-guia em uma montagem que impedem fisicamente que uma peça seja montada ao contrário.", correta: false },
                { texto: "A gaveta de um caixa eletrônico que só libera o dinheiro após o cliente retirar o cartão (evitando o esquecimento).", correta: false }
              ], nivel: 'dificil', pontos: 8, bloom: 'Análise' }, // Mudei para difícil, pois a C é a única que confia na disciplina, não no design.

            // Grupo 16: 5 Porquês (Médio - Estudo de Caso)
            { id: 16.1, grupo: 16, texto: "Estudo de Caso: Uma impressora de escritório para de funcionar (Problema). Um funcionário desliga e liga, e ela volta a funcionar (Solução 1). Duas horas depois, ela para novamente. O técnico de TI aplica os '5 Porquês' (uma técnica de Análise de Causa Raiz, ou RCA) e descobre que a causa raiz é um 'driver de software desatualizado no servidor'. O que a primeira solução (desligar e ligar) falhou em fazer?",
              alternativas: [
                { texto: "Falhou em resolver o sintoma (a impressora travada) e focou apenas na causa raiz (o driver).", correta: false },
                { texto: "Falhou em aplicar o Poka-Yoke, que teria impedido o driver de ficar desatualizado.", correta: false },
                { texto: "Falhou em atacar a causa raiz (o driver) e resolveu apenas o sintoma superficial e temporário (a impressora travada).", correta: true },
                { texto: "Falhou em implementar o JIT, que teria fornecido um novo driver no momento exato em que ele ficou desatualizado.", correta: false },
                { texto: "Falhou em usar o VSM para mapear o processo de impressão no escritório.", correta: false }
              ], nivel: 'medio', pontos: 5, bloom: 'Aplicação' },
            { id: 16.2, grupo: 16, texto: "Estudo de Caso: No exemplo clássico de Taiichi Ohno, uma máquina para. 1º Porquê: O fusível queimou. 2º Porquê: Sobrecarga. 3º Porquê: Falta de lubrificação. 4º Porquê: Bomba de lubrificação falhou. 5º Porquê: Cavacos (aparas) de metal entraram na bomba. Se a equipe tivesse parado no 1º Porquê (trocar o fusível), o que teria acontecido?",
              alternativas: [
                { texto: "O problema teria sido resolvido permanentemente, pois a troca do fusível (a causa raiz) corrigiu o sistema.", correta: false },
                { texto: "O problema (parada da máquina) teria ocorrido novamente, pois trocar o fusível foi apenas uma solução para o sintoma, não para a causa raiz (cavacos).", correta: true },
                { texto: "A equipe teria aplicado um Poka-Yoke (à prova de erros) ao trocar o fusível, impedindo futuras falhas.", correta: false },
                { texto: "A equipe teria implementado o Jidoka (autonomação) ao identificar que o fusível era a causa raiz.", correta: false },
                
                { texto: "A equipe teria gasto muito tempo desnecessariamente, pois a troca do fusível era a única ação necessária.", correta: false }
              ], nivel: 'medio', pontos: 5, bloom: 'Análise' },

            // Grupo 17: 5S (Fácil - Conhecimento)
            { id: 17.1, grupo: 17, texto: "O 5S é a fundação para a estabilidade, focado na organização e disciplina. Qual 'S' é descrito como 'Um lugar para cada coisa, e cada coisa em seu lugar', focando em organizar os itens necessários para que sejam fáceis de encontrar, usar e guardar?",
              alternativas: [
                { texto: "Seiri (Senso de Utilização / Classificar)", correta: false },
                { texto: "Seiton (Senso de Ordenação)", correta: true },
                { texto: "Seiso (Senso de Limpeza)", correta: false },
                { texto: "Seiketsu (Senso de Padronização)", correta: false },
                { texto: "Shitsuke (Senso de Disciplina)", correta: false }
              ], nivel: 'facil', pontos: 3, bloom: 'Conhecimento' },
            { id: 17.2, grupo: 17, texto: "O 5S é uma metodologia de gestão para criar um local de trabalho estável. O primeiro passo, 'Seiri' (Classificar), envolve separar o necessário do desnecessário. O segundo, 'Seiton' (Ordenar), é 'um lugar para cada coisa'. O que é 'Seiso' (Limpar)?",
              alternativas: [
                { texto: "Criar os padrões e regras visuais para manter os três primeiros 'S' de forma consistente.", correta: false },
                { texto: "Manter os padrões e transformar a prática do 5S em um hábito e parte da cultura.", correta: false },
                { texto: "Limpar o local de trabalho, o que no Lean também é uma forma de inspeção (ex: um chão limpo revela vazamentos).", correta: true },
                { texto: "Descartar os itens desnecessários que foram identificados na etapa de classificação (Seiri).", correta: false },
                { texto: "Organizar os itens necessários para que sejam fáceis de encontrar (esta é a definição de Seiton).", correta: false }
              ], nivel: 'facil', pontos: 3, bloom: 'Conhecimento' },

            // Grupo 18: TPM e JIT (Difícil - Síntese)
            { id: 18.1, grupo: 18, texto: "Estudo de Caso: Uma fábrica implementa o JIT (Just-in-Time) e reduz seus estoques de dias para horas. Eles operam com um fluxo 'puxado' e enxuto. No entanto, eles não implementam a Manutenção Produtiva Total (TPM), uma estratégia que foca em 'Zero Falhas Não Planejadas'. Por que o TPM é um habilitador crítico para um sistema JIT?",
              alternativas: [
                { texto: "Porque o JIT opera sem estoques de segurança. Em um sistema tradicional (Push), se uma máquina quebra, a linha continua com o estoque. Em um sistema JIT, uma quebra de máquina (falha de TPM) para o fluxo inteiro, gerando 'Espera'.", correta: true },
                { texto: "Porque o TPM é o mesmo que Jidoka (qualidade na fonte), e o JIT não pode funcionar sem o Jidoka.", correta: false },
                { texto: "Porque o TPM foca em 'Zero Acidentes', e um sistema JIT é inerentemente mais perigoso para os operadores.", correta: false },
                { texto: "Porque o TPM é o mesmo que 5S (Organização), e a limpeza é necessária para que o Kanban (JIT) funcione.", correta: false },
                { texto: "Porque o JIT (produção puxada) e o TPM (manutenção) são conceitos opostos; uma empresa deve escolher apenas um.", correta: false }
              ], nivel: 'dificil', pontos: 8, bloom: 'Síntese' },
            { id: 18.2, grupo: 18, texto: "Estudo de Caso: Uma gráfica adota o 'Fluxo Contínuo' (Princípio 3) e o JIT (Princípio 4). O estoque intermediário (WIP) entre a Impressora A e a Cortadora B é zero. A Cortadora B quebra inesperadamente (uma falha de TPM - Manutenção Produtiva Total). O que acontece imediatamente com a Impressora A e o sistema como um todo?",
              alternativas: [
                { texto: "Nada. A Impressora A continua operando em 'Superprodução' (Push), criando um grande 'Estoque' (Muda) na frente da Cortadora B quebrada.", correta: false },
                { texto: "O sistema JIT/Fluxo Contínuo (sem estoque) faz com que a Impressora A pare quase imediatamente, pois não há onde colocar sua produção, gerando 'Espera' (Muda) em todo o sistema.", correta: true },
                { texto: "A quebra da Cortadora B (falha de TPM) é um exemplo de Jidoka (qualidade), pois impede que impressões ruins sejam cortadas.", correta: false },
                { texto: "O sistema automaticamente aciona um 'Kanban' de emergência para que a Impressora A produza o dobro e compense a falha.", correta: false },
                { texto: "Apenas a Cortadora B para. A Impressora A continua funcionando e enviando seu material para um estoque de segurança.", correta: false }
              ], nivel: 'dificil', pontos: 8, bloom: 'Síntese' },
            
            // Grupo 19: Lean Office (Médio - Estudo de Caso)
            { id: 19.1, grupo: 19, texto: "Estudo de Caso: A aplicação do Lean em escritórios (Lean Office) foca no 'fluxo de informação'. Em um processo de aprovação de despesas, um relatório digital precisa passar por 7 gerentes (Processamento Excessivo), ficando em média 2 dias na caixa de entrada de e-mail de cada um (Espera / Inventário). Embora o trabalho real de aprovação leve 5 minutos por gerente, o processo total leva 14 dias. Como o Lean Office enxerga isso?",
              alternativas: [
                { texto: "Como um processo robusto e seguro, pois as 7 aprovações garantem o controle financeiro (Muda Tipo 1).", correta: false },
                { texto: "Como um processo invisível, mas cheio de desperdícios (Muda Tipo 2), onde o 'produto' (o relatório) fica 99% do tempo parado em 'Inventário' (caixa de entrada).", correta: true },
                { texto: "Como um problema de 'Movimento' (Muda), pois os gerentes precisam mover o mouse para clicar em 'aprovar'.", correta: false },
                { texto: "Como um problema de 'Muri' (Sobrecarga), pois os 7 gerentes estão claramente sobrecarregados e não conseguem ler e-mails.", correta: false },
                { texto: "Como um problema de TPM (Manutenção), pois o servidor de e-mail provavelmente está lento e precisa de manutenção.", correta: false }
              ], nivel: 'medio', pontos: 5, bloom: 'Aplicação' },
            { id: 19.2, grupo: 19, texto: "Estudo de Caso: Em um hospital (Lean Healthcare), a jornada do paciente para um exame de raio-X envolve: 1. Check-in (5 min). 2. Espera na Sala A (30 min). 3. Triagem (10 min). 4. Espera na Sala B (40 min). 5. Raio-X (5 min). 6. Espera na Sala C (15 min). 7. Consulta com médico (10 min). O Lead Time total é de 115 minutos, mas o Tempo de Agregação de Valor (VA) é de 30 minutos. Qual é o principal desafio que o Lean busca resolver aqui?",
              alternativas: [
                { texto: "O 'Movimento' (Muda) do paciente entre as salas A, B e C, que é o maior desperdício de tempo.", correta: false },
                { texto: "O 'Processamento Excessivo' (Muda) da máquina de Raio-X, que provavelmente é muito cara.", correta: false },
                { texto: "Os 85 minutos de 'Espera' (Muda), que representam o fluxo de trabalho invisível e bloqueado do paciente.", correta: true },
                { texto: "O 'Defeito' (Muda) na qualidade do Raio-X, que pode exigir retrabalho (repetir o exame).", correta: false },
                { texto: "O 'Talento Não Utilizado' (Muda) do médico, que só gasta 10 minutos com o paciente.", correta: false }
              ], nivel: 'medio', pontos: 5, bloom: 'Análise' },

            // Grupo 20: Lean Startup (Difícil - Síntese)
            { id: 20.1, grupo: 20, texto: "Estudo de Caso: Uma startup de tecnologia gasta dois anos desenvolvendo um aplicativo complexo com 100 recursos, operando em 'modo secreto' (sem feedback). Ao lançar, descobre que o mercado não quer o produto (o maior desperdício de todos). A 'Lean Startup' evita isso usando o ciclo 'Construir-Medir-Aprender'. O que a startup deveria ter 'Construído' primeiro?",
              alternativas: [
                { texto: "Um plano de negócios (VSM) muito mais detalhado, com previsões financeiras (Push) para 10 anos.", correta: false },
                { texto: "Um Produto Mínimo Viável (MVP), a versão mais simples do produto (com talvez 1 ou 2 recursos) usada para testar a hipótese fundamental do negócio com clientes reais (early adopters).", correta: true },
                { texto: "Um Poka-Yoke (à prova de erros) para garantir que os programadores não criassem bugs no código dos 100 recursos.", correta: false },
                { texto: "Um sistema Jidoka (autonomação) para parar o desenvolvimento se os programadores ficassem sobrecarregados (Muri).", correta: false },
                { texto: "Um escritório perfeitamente organizado (5S), pois a desorganização foi a causa da falha do produto.", correta: false }
              ], nivel: 'dificil', pontos: 8, bloom: 'Síntese' },
            { id: 20.2, grupo: 20, texto: "O ciclo 'Construir-Medir-Aprender' da metodologia Lean Startup é a aplicação direta de qual outro conceito fundamental do Lean/TPS, usado para aplicar o método científico à melhoria?",
              alternativas: [
                { texto: "Do Jidoka (Autonomação), pois 'Medir' (Check) para o processo se a hipótese estiver errada.", correta: false },
                { texto: "Do Ciclo PDCA (Plan-Do-Check-Act). 'Construir' é (Do), 'Medir' é (Check), e 'Aprender' (Perseverar/Pivotar) é (Act) e o novo (Plan).", correta: true },
                { texto: "Do 5S (Organização), pois 'Construir' (Seiri), 'Medir' (Seiton) e 'Aprender' (Seiso) organizam a startup.", correta: false },
                { texto: "Do Kanban (Sinal Visual), pois o feedback do cliente ('Aprender') é um sinal visual para 'Construir' mais.", correta: false },
                { texto: "Do VSM (Mapeamento do Fluxo de Valor), pois o ciclo mapeia o fluxo de valor do aprendizado validado.", correta: false }
              ], nivel: 'dificil', pontos: 8, bloom: 'Síntese' }
        ];

        // --- Seletores de DOM ---
        const inicioContainer = document.getElementById('inicio-container');
        const avisoContainer = document.getElementById('aviso-container');
        const quizContainer = document.getElementById('quiz-container');
        const resultadoContainer = document.getElementById('resultado-container');
        const eliminadoContainer = document.getElementById('eliminado-container');
        const modalAlerta = document.getElementById('modal-alerta');
        const modalPdf = document.getElementById('modal-pdf');
        const modalLoginProfessor = document.getElementById('modal-login-professor');
        const adminContainer = document.getElementById('admin-container');
        
        const formInicio = document.getElementById('form-inicio');
        const comecarQuizBtn = document.getElementById('comecar-quiz-btn');
        const fecharModalBtn = document.getElementById('fechar-modal-btn');
        const proximaBtn = document.getElementById('proxima-btn');
        const consultarBtn = document.getElementById('consultar-btn');
        const fecharPdfBtn = document.getElementById('fechar-pdf-btn');
        const loginProfessorBtn = document.getElementById('login-professor-btn');
        const formLoginProfessor = document.getElementById('form-login-professor');
        const cancelarLoginBtn = document.getElementById('cancelar-login-btn');
        const erroLoginProfessor = document.getElementById('erro-login-professor');
        const buscarNotasBtn = document.getElementById('buscar-notas-btn');
        const exportarCsvBtn = document.getElementById('exportar-csv-btn');
        const adminVoltarBtn = document.getElementById('admin-voltar-btn');
        const adminFeedback = document.getElementById('admin-feedback');
        const tabelaResultados = document.getElementById('tabela-resultados');
        const tabelaResultadosBody = document.getElementById('tabela-resultados-body');

        // --- Inicialização da Aplicação ---
        
        /**
         * Inicializa o Firebase e a autenticação.
         */
        async function inicializarFirebase() {
            try {
                // Habilitar logs detalhados do Firestore para depuração
                setLogLevel('debug'); 
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                console.log("Firebase App inicializado.");
                console.log("App ID:", appId);

                // Gerenciar estado de autenticação
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("Usuário autenticado:", user.uid);
                        userId = user.uid;
                    } else {
                        console.log("Usuário não autenticado.");
                        userId = null;
                        // Tentar login se não estiver logado
                        autenticarUsuario(); 
                    }
                });

                // Se o onAuthStateChanged não pegar imediatamente, forçamos a autenticação
                if (!auth.currentUser) {
                    await autenticarUsuario();
                } else {
                    userId = auth.currentUser.uid;
                }
                
            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                // Tentar login anônimo como fallback
                if (!auth) {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    await signInAnonymously(auth);
                    userId = auth.currentUser.uid;
                }
            }
        }

        /**
         * Autentica o usuário, priorizando o token inicial, ou caindo para anônimo.
         */
        async function autenticarUsuario() {
            try {
                if (initialAuthToken) {
                    console.log("Autenticando com token customizado...");
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    console.log("Autenticando anonimamente...");
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser.uid;
                console.log("Autenticação bem-sucedida, UID:", userId);
            } catch (error) {
                console.error("Erro durante a autenticação:", error);
                // Criar um ID de fallback para a sessão
                if (!userId) {
                    userId = 'fallback-' + crypto.randomUUID();
                    console.warn("Usando UID de fallback:", userId);
                }
            }
        }

        /**
         * Define a data de hoje no campo de data.
         */
        function preencherDataAtual() {
            const dataInput = document.getElementById('data');
            const hoje = new Date();
            const offset = hoje.getTimezoneOffset();
            const dataLocal = new Date(hoje.getTime() - (offset*60*1000));
            dataInput.value = dataLocal.toISOString().split('T')[0];
        }

        // --- Lógica do Quiz ---
        
        /**
         * Chamado quando o formulário inicial é enviado.
         * Salva os dados do aluno e mostra o aviso de segurança.
         */
        function handleInicioForm(event) {
            event.preventDefault();
            const nome = document.getElementById('nome').value.trim();
            const colegio = document.getElementById('colegio').value.trim();
            const data = document.getElementById('data').value;

            if (nome && colegio && data) {
                infoAluno = {
                    nome: nome,
                    colegio: colegio,
                    data: data,
                    dataHoraInicio: new Date().toISOString()
                };
                
                // Atualiza os dados do aluno na tela do quiz
                document.getElementById('nome-aluno-quiz').textContent = infoAluno.nome;
                document.getElementById('colegio-aluno-quiz').textContent = infoAluno.colegio;
                
                // Transição de telas
                inicioContainer.classList.add('hidden');
                avisoContainer.classList.remove('hidden');
            } else {
                alert("Por favor, preencha todos os campos.");
            }
        }

        /**
         * Inicia o quiz após o aluno aceitar o aviso.
         */
        function comecarQuiz() {
            provaIniciada = true;
            tentativasSaida = 0;
            pontuacaoTotal = 0;
            pontuacaoMaximaPossivel = 0;
            questaoAtualIndex = 0;
            respostasAluno = [];
            
            sortearQuestoes();
            mostrarQuestao();
            
            // Transição de telas
            avisoContainer.classList.add('hidden');
            quizContainer.classList.remove('hidden');

            // Ativa os listeners de segurança
            ativarListenersSeguranca();
        }

        /**
         * Sorteia 20 questões do banco, garantindo uma de cada grupo.
         */
        function sortearQuestoes() {
            questoesSorteadas = [];
            pontuacaoMaximaPossivel = 0;
            
            const grupos = new Set(questionBank.map(q => q.grupo));
            
            if (grupos.size < 20) {
                console.error("Banco de questões não tem 20 grupos únicos!");
                // Fallback: apenas pega 20 questões aleatórias
                questoesSorteadas = [...questionBank].sort(() => 0.5 - Math.random()).slice(0, 20);
            } else {
                // Seleciona 20 grupos aleatoriamente
                const gruposSorteados = [...grupos].sort(() => 0.5 - Math.random()).slice(0, 20);
                
                for (const grupoId of gruposSorteados) {
                    const questoesDoGrupo = questionBank.filter(q => q.grupo === grupoId);
                    // Sorteia uma variação dentro do grupo
                    const questaoSorteada = questoesDoGrupo[Math.floor(Math.random() * questoesDoGrupo.length)];
                    questoesSorteadas.push(questaoSorteada);
                }
            }
            
            // Embaralha a ordem final das 20 questões
            questoesSorteadas.sort(() => 0.5 - Math.random());
            
            // Calcula a pontuação máxima
            pontuacaoMaximaPossivel = questoesSorteadas.reduce((acc, q) => acc + q.pontos, 0);
            document.getElementById('questao-total-num').textContent = questoesSorteadas.length;
        }

        /**
         * Exibe a questão atual na tela.
         */
        function mostrarQuestao() {
            // Limpa o estado da questão anterior
            alternativaSelecionada = null;
            proximaBtn.disabled = true;
            proximaBtn.classList.add('bg-gray-400');
            proximaBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            
            if (questaoAtualIndex >= questoesSorteadas.length) {
                finalizarProva();
                return;
            }

            const questao = questoesSorteadas[questaoAtualIndex];
            
            // Atualiza informações da questão
            document.getElementById('questao-atual-num').textContent = questaoAtualIndex + 1;
            document.getElementById('texto-questao').textContent = questao.texto;
            
            // Mostra a pontuação e nível
            const pontosQuestaoDiv = document.getElementById('pontos-questao');
            pontosQuestaoDiv.textContent = `Nível: ${questao.nivel.charAt(0).toUpperCase() + questao.nivel.slice(1)} (${questao.pontos} pontos)`;
            pontosQuestaoDiv.className = 'text-sm font-medium px-2 py-1 rounded'; // Reset
            if (questao.nivel === 'facil') {
                pontosQuestaoDiv.classList.add('bg-green-100', 'text-green-700');
            } else if (questao.nivel === 'medio') {
                pontosQuestaoDiv.classList.add('bg-yellow-100', 'text-yellow-700');
            } else {
                pontosQuestaoDiv.classList.add('bg-red-100', 'text-red-700');
            }

            // Embaralha e exibe as alternativas
            const alternativasContainer = document.getElementById('alternativas-container');
            alternativasContainer.innerHTML = '';
            
            const alternativasEmbaralhadas = [...questao.alternativas].sort(() => 0.5 - Math.random());
            
            alternativasEmbaralhadas.forEach(alt => {
                const altDiv = document.createElement('div');
                altDiv.className = 'border border-gray-300 rounded-lg p-4 cursor-pointer hover:bg-gray-100 transition-all duration-200';
                altDiv.textContent = alt.texto;
                
                altDiv.addEventListener('click', () => {
                    // Remove a seleção de outras
                    Array.from(alternativasContainer.children).forEach(child => {
                        child.classList.remove('alternativa-selecionada');
                        child.classList.add('border-gray-300');
                    });
                    
                    // Adiciona seleção a esta
                    altDiv.classList.add('alternativa-selecionada');
                    altDiv.classList.remove('border-gray-300');
                    
                    alternativaSelecionada = alt;
                    
                    // Habilita o botão de próxima
                    proximaBtn.disabled = false;
                    proximaBtn.classList.remove('bg-gray-400');
                    proximaBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                });
                
                alternativasContainer.appendChild(altDiv);
            });

            // Atualiza o texto do botão para a última questão
            if (questaoAtualIndex === questoesSorteadas.length - 1) {
                proximaBtn.textContent = 'Finalizar Prova';
            } else {
                proximaBtn.textContent = 'Próxima Questão';
            }
            
            // Adiciona animação de fade-in
            document.getElementById('questao-card').classList.remove('fade-in');
            void document.getElementById('questao-card').offsetWidth; // Força o reflow para reiniciar a animação
            document.getElementById('questao-card').classList.add('fade-in');
        }

        /**
         * Processa a resposta e avança para a próxima questão.
         */
        function proximaQuestao() {
            if (!alternativaSelecionada) return;

            const questao = questoesSorteadas[questaoAtualIndex];

            // Calcula pontuação
            if (alternativaSelecionada.correta) {
                pontuacaoTotal += questao.pontos;
            }

            // Salva a resposta do aluno
            respostasAluno.push({
                grupo: questao.grupo,
                id: questao.id,
                textoQuestao: questao.texto,
                textoResposta: alternativaSelecionada.texto,
                correta: alternativaSelecionada.correta,
                pontosGanhos: alternativaSelecionada.correta ? questao.pontos : 0,
                pontosPossiveis: questao.pontos
            });

            // Avança para a próxima questão
            questaoAtualIndex++;
            mostrarQuestao();
        }

        /**
         * Finaliza a prova, exibe os resultados e salva no Firebase.
         */
        async function finalizarProva() {
            provaIniciada = false;
            desativarListenersSeguranca();

            // Exibe tela de resultados
            document.getElementById('nome-aluno-resultado').textContent = infoAluno.nome;
            document.getElementById('pontuacao-final').textContent = pontuacaoTotal;
            document.getElementById('pontuacao-maxima').textContent = pontuacaoMaximaPossivel;

            quizContainer.classList.add('hidden');
            resultadoContainer.classList.remove('hidden');

            const feedbackFirebase = document.getElementById('feedback-firebase');
            feedbackFirebase.textContent = 'Salvando seu resultado...';
            
            // Salva no Firebase
            try {
                if (!db || !userId || !appId) {
                    console.error("Firebase DB, UserID ou AppID não estão prontos.");
                    throw new Error("Falha na conexão com o banco de dados.");
                }
                
                const resultadoDoc = {
                    appId: appId,
                    userId: userId,
                    aluno: infoAluno,
                    pontuacao: pontuacaoTotal,
                    pontuacaoMaxima: pontuacaoMaximaPossivel,
                    dataHoraFim: new Date().toISOString(),
                    respostas: respostasAluno,
                    questoesSorteadas: questoesSorteadas.map(q => q.id) // Salva os IDs das questões
                };

                // Caminho da coleção pública
                const collectionPath = `artifacts/${appId}/public/data/resultadosProvas`;
                
                // Adiciona um novo documento com ID gerado automaticamente
                const docRef = await addDoc(collection(db, collectionPath), resultadoDoc);
                
                console.log("Resultado salvo com sucesso no Firestore. Doc ID:", docRef.id);
                feedbackFirebase.textContent = 'Seu resultado foi salvo com sucesso!';
                feedbackFirebase.classList.add('text-green-600');
                feedbackFirebase.classList.remove('text-gray-500', 'text-red-600');

            } catch (error) {
                console.error("Erro ao salvar resultado no Firestore:", error);
                feedbackFirebase.textContent = 'Erro ao salvar seu resultado. Por favor, tire um print desta tela.';
                feedbackFirebase.classList.add('text-red-600');
                feedbackFirebase.classList.remove('text-gray-500', 'text-green-600');
            }
        }

        /**
         * Reinicia a prova, voltando para a tela inicial.
         */
        window.reiniciarProva = function() {
            // Reseta todas as variáveis de estado
            infoAluno = {};
            questoesSorteadas = [];
            questaoAtualIndex = 0;
            pontuacaoTotal = 0;
            pontuacaoMaximaPossivel = 0;
            respostasAluno = [];
            alternativaSelecionada = null;
            tentativasSaida = 0;
            provaIniciada = false;

            // Limpa formulário inicial
            formInicio.reset();
            preencherDataAtual();

            // Esconde todas as telas e mostra a inicial
            inicioContainer.classList.remove('hidden');
            avisoContainer.classList.add('hidden');
            quizContainer.classList.add('hidden');
            resultadoContainer.classList.add('hidden');
            eliminadoContainer.classList.add('hidden');
            modalAlerta.classList.add('hidden');

            // Garante que os botões estejam no estado inicial
            proximaBtn.textContent = 'Próxima Questão';
            proximaBtn.disabled = true;
            proximaBtn.classList.add('bg-gray-400');
            proximaBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');

            // Esconde a tela de admin também
            adminContainer.classList.add('hidden');
        }

        // --- Lógica de Segurança Anti-Cola ---
        
        /**
         * Função unificada para lidar com ações anormais.
         */
        function handleAcaoAnormal(evento) {
            if (!provaIniciada) return;
            
            console.warn(`Ação anormal detectada: ${evento.type}`);
            
            tentativasSaida++;

            if (tentativasSaida === 1) {
                // Primeira ofensa: Mostrar modal de alerta
                modalAlerta.classList.remove('hidden');
                // Pausa a prova (embora o JS continue rodando, isso impede o aluno de ver)
            } else if (tentativasSaida > 1) {
                // Segunda ofensa: Eliminar
                eliminarAluno();
            }
        }

        /**
         * Encerra a prova e mostra a tela de eliminação.
         */
        function eliminarAluno() {
            provaIniciada = false;
            desativarListenersSeguranca();

            // Esconde outras telas e mostra a de eliminação
            quizContainer.classList.add('hidden');
            modalAlerta.classList.add('hidden');
            eliminadoContainer.classList.remove('hidden');
            
            // Opcional: Salvar no Firebase que o aluno foi eliminado
            // (Vou pular isso por enquanto para manter simples)
        }

        /**
         * Fecha o modal de alerta e permite que o aluno continue.
         */
        function fecharModal() {
            modalAlerta.classList.add('hidden');
            // O aluno pode voltar à prova
        }

        // --- Funções do Modal PDF ---
        function abrirModalPdf() {
            isModalPdfOpen = true;
            modalPdf.classList.remove('hidden');
        }

        function fecharModalPdf() {
            isModalPdfOpen = false;
            modalPdf.classList.add('hidden');
        }

        // --- Funções dos Listeners ---
        // (Definidas separadamente para poderem ser removidas)
        
        function onVisibilityChange() {
            if (document.hidden) {
                handleAcaoAnormal({ type: 'visibilitychange' });
            }
        }
        
        function onBlur() {
            // O 'blur' pode ser barulhento, especialmente com o modal
            // Vamos checar se o modal está visível
            if (!modalAlerta.classList.contains('hidden') || isModalPdfOpen) {
                return; // Ignora o blur se o modal de alerta OU o modal do PDF estiverem ativos
            }
            // Adiciona um pequeno delay para evitar falsos positivos ao clicar em coisas do navegador
            setTimeout(() => {
                if (document.visibilityState === 'visible' && !document.hasFocus()) {
                   handleAcaoAnormal({ type: 'blur' });
                }
            }, 500);
        }

        function onCopy(event) {
            handleAcaoAnormal({ type: 'copy' });
            event.preventDefault(); // Impede a cópia
        }

        function onFullscreenChange() {
            if (!document.fullscreenElement) {
                // Se saiu da tela cheia, conta como ação anormal
                handleAcaoAnormal({ type: 'fullscreenexit' });
            }
        }

        /**
         * Adiciona todos os listeners de segurança.
         */
        function ativarListenersSeguranca() {
            document.addEventListener('visibilitychange', onVisibilityChange);
            window.addEventListener('blur', onBlur);
            document.addEventListener('copy', onCopy);
            
            // Monitora a saída da tela cheia
            document.addEventListener('fullscreenchange', onFullscreenChange);
            document.addEventListener('webkitfullscreenchange', onFullscreenChange);
            document.addEventListener('mozfullscreenchange', onFullscreenChange);
            document.addEventListener('MSFullscreenChange', onFullscreenChange);
            
            // Impede o clique direito
            document.addEventListener('contextmenu', event => event.preventDefault());
        }

        /**
         * Remove todos os listeners de segurança.
         */
        function desativarListenersSeguranca() {
            document.removeEventListener('visibilitychange', onVisibilityChange);
            window.removeEventListener('blur', onBlur);
            document.removeEventListener('copy', onCopy);
            
            document.removeEventListener('fullscreenchange', onFullscreenChange);
            document.removeEventListener('webkitfullscreenchange', onFullscreenChange);
            document.removeEventListener('mozfullscreenchange', onFullscreenChange);
            document.removeEventListener('MSFullscreenChange', onFullscreenChange);

            document.removeEventListener('contextmenu', event => event.preventDefault());
        }

        // --- Funções do Admin (Professor) ---

        /**
         * Exibe o modal de login do professor.
         */
        function abrirModalLoginProfessor() {
            erroLoginProfessor.classList.add('hidden');
            document.getElementById('senha-professor').value = '';
            modalLoginProfessor.classList.remove('hidden');
        }

        /**
         * Fecha o modal de login do professor.
         */
        function fecharModalLoginProfessor() {
            modalLoginProfessor.classList.add('hidden');
        }

        /**
         * Valida a senha do professor e exibe o painel de admin.
         */
        function handleLoginProfessor(event) {
            event.preventDefault();
            const senha = document.getElementById('senha-professor').value;

            if (senha === 'avaliacao#2025') {
                // Senha correta
                fecharModalLoginProfessor();
                inicioContainer.classList.add('hidden');
                adminContainer.classList.remove('hidden');
                
                // Limpa tabela anterior, se houver
                adminFeedback.textContent = 'Clique em "Buscar Notas" para carregar os resultados.';
                adminFeedback.classList.remove('hidden');
                tabelaResultados.classList.add('hidden');
                tabelaResultadosBody.innerHTML = '';
                exportarCsvBtn.classList.add('hidden');
                dadosAlunosExport = [];

            } else {
                // Senha incorreta
                erroLoginProfessor.classList.remove('hidden');
            }
        }

        /**
         * Busca todos os resultados do Firestore e exibe na tabela.
         */
        async function buscarNotasAlunos() {
            adminFeedback.textContent = 'Buscando resultados no banco de dados...';
            adminFeedback.classList.remove('hidden');
            tabelaResultados.classList.add('hidden');
            tabelaResultadosBody.innerHTML = '';
            exportarCsvBtn.classList.add('hidden');
            dadosAlunosExport = []; // Limpa dados anteriores

            try {
                if (!db || !appId) {
                    throw new Error("Conexão com Firebase não estabelecida.");
                }

                const collectionPath = `artifacts/${appId}/public/data/resultadosProvas`;
                const q = query(collection(db, collectionPath));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    adminFeedback.textContent = 'Nenhum resultado de aluno encontrado.';
                    return;
                }

                let linhasTabela = '';
                
                // Prepara dados para exportação CSV (cabeçalho)
                dadosAlunosExport.push(['ID_Prova', 'Nome_Aluno', 'Colegio', 'Data_Prova', 'Pontuacao', 'Pontuacao_Maxima', 'Data_Inicio', 'Data_Fim']);

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const aluno = data.aluno || {};
                    
                    // Adiciona à tabela HTML
                    linhasTabela += `
                        <tr class="hover:bg-gray-50">
                            <td class="py-2 px-4 border-b">${aluno.nome || 'N/A'}</td>
                            <td class="py-2 px-4 border-b">${aluno.colegio || 'N/A'}</td>
                            <td class="py-2 px-4 border-b">${aluno.data || 'N/A'}</td>
                            <td class="py-2 px-4 border-b font-bold text-blue-700">${data.pontuacao}</td>
                            <td class="py-2 px-4 border-b">${data.pontuacaoMaxima}</td>
                            <td class="py-2 px-4 border-b text-xs">${doc.id}</td>
                        </tr>
                    `;
                    
                    // Adiciona aos dados de exportação (limpando vírgulas)
                    const limpar = (str) => (str || '').replace(/,/g, ''); // Remove vírgulas para CSV
                    dadosAlunosExport.push([
                        doc.id,
                        limpar(aluno.nome),
                        limpar(aluno.colegio),
                        aluno.data || 'N/A',
                        data.pontuacao,
                        data.pontuacaoMaxima,
                        aluno.dataHoraInicio || 'N/A',
                        data.dataHoraFim || 'N/A'
                    ]);
                });

                tabelaResultadosBody.innerHTML = linhasTabela;
                tabelaResultados.classList.remove('hidden');
                adminFeedback.classList.add('hidden');
                exportarCsvBtn.classList.remove('hidden');

            } catch (error) {
                console.error("Erro ao buscar notas:", error);
                adminFeedback.textContent = `Erro ao buscar dados: ${error.message}`;
                adminFeedback.classList.add('text-red-600');
            }
        }

        /**
         * Exporta os dados da tabela para um arquivo CSV.
         */
        function exportarParaCSV() {
            if (dadosAlunosExport.length === 0) {
                alert("Não há dados para exportar. Clique em 'Buscar Notas' primeiro.");
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            
            dadosAlunosExport.forEach(rowArray => {
               let row = rowArray.join(",");
               csvContent += row + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `export_notas_lean_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        /**
         * Volta da tela de admin para a tela inicial.
         */
        function voltarParaInicio() {
            adminContainer.classList.add('hidden');
            inicioContainer.classList.remove('hidden');
        }


        // --- Event Listeners Iniciais ---
        formInicio.addEventListener('submit', handleInicioForm);
        comecarQuizBtn.addEventListener('click', comecarQuiz);
        fecharModalBtn.addEventListener('click', fecharModal);
        proximaBtn.addEventListener('click', proximaQuestao);
        consultarBtn.addEventListener('click', abrirModalPdf);
        fecharPdfBtn.addEventListener('click', fecharModalPdf);
        
        // Listeners do Admin
        loginProfessorBtn.addEventListener('click', abrirModalLoginProfessor);
        cancelarLoginBtn.addEventListener('click', fecharModalLoginProfessor);
        formLoginProfessor.addEventListener('submit', handleLoginProfessor);
        adminVoltarBtn.addEventListener('click', voltarParaInicio);
        buscarNotasBtn.addEventListener('click', buscarNotasAlunos);
        exportarCsvBtn.addEventListener('click', exportarParaCSV);

        // --- Inicialização ao Carregar a Página ---
        document.addEventListener('DOMContentLoaded', () => {
            inicializarFirebase();
            preencherDataAtual();
            // Garante que o estado inicial esteja limpo
            reiniciarProva(); 
        });

    </script>
    
</body>
</html>
